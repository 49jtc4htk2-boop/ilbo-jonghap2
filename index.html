<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>일일 전도 활동 종합 계산기</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; padding:10px; }
h2 { text-align:center; margin-bottom:10px; }
textarea { width:100%; height:250px; font-size:16px; padding:10px; margin-bottom:10px; }
button { width:100%; font-size:16px; padding:10px; margin:5px 0;
  border:none; border-radius:5px; background:#0081ff; color:white; }
button:hover { background:#0081ff; }
#result { margin-top:10px; font-weight:bold; font-size:18px;
  background:#fff; padding:10px; border-radius:5px; word-break:break-word; }
</style>
</head>
<body>

<h2>일일 전도 활동 종합 계산기</h2>

<textarea id="inputText" placeholder="일보 텍스트를 여기에 붙여넣기"></textarea>
<button id="calculateBtn">종합하기</button>
<div id="result"></div>
<button id="copyBtn">결과 복사</button>

<script>
const COL_NAMES = {
  2:"섭외자보유", 3:"당일 찾기", 4:"당일 섭외", 5:"당일 만남",
  6:"단계향상 만남", 7:"상담따기", 8:"말씀따기", 9:"센터확답"
};
const ALLOWED = ["당일 찾기","당일 섭외","당일 만남"];

document.getElementById("calculateBtn").onclick = () => {
  const lines = document.getElementById("inputText").value.split(/\r?\n/);
  const sums = Array(8).fill(0);
  const nameCols = {};
  const halfCount = {};
  const wordNames = {};   // 말씀따기
  const centerNames = {}; // 센터확답
  const errors = [];

  lines.forEach((line, li) => {
    if(!/^\d+\//.test(line)) return;
    const parts = line.split("/");

    for(let i=2;i<=9;i++){
      const cell = parts[i];
      if(!cell) continue;

      const n = parseFloat(cell);
      if(!isNaN(n)) sums[i-2] += n;

      const m = cell.match(/\(([^)]+)\)/);
      if(!m) continue;

      m[1].split(" ").forEach(raw => {
        const name = raw.replace(/[0-9.]/g,"");
        const num  = parseFloat(raw.replace(name,"")) || 0;
        const col = COL_NAMES[i];

        /* .5 체크 */
        if(raw.includes(".5")){
          halfCount[name] = (halfCount[name]||0)+1;
        }

        /* 섭외자보유 제외 충돌 체크 */
        if(col !== "섭외자보유"){
          if(!nameCols[name]) nameCols[name] = new Set();
          nameCols[name].add(col);
        }

        /* 말씀따기 / 센터확답 이름 합산 */
        if(col === "말씀따기"){
          wordNames[name] = (wordNames[name]||0)+num;
        }
        if(col === "센터확답"){
          centerNames[name] = (centerNames[name]||0)+num;
        }
      });
    }
  });

  /* 충돌 오류 */
  for(const name in nameCols){
    const cols = [...nameCols[name]];
    const illegal = cols.filter(c=>!ALLOWED.includes(c));
    if(illegal.length >= 2){
      errors.push(`"${name}": ${illegal.join(" vs ")}`);
    }
  }

  /* .5 단독 */
  for(const n in halfCount){
    if(halfCount[n] === 1){
      errors.push(`"${n}.5"는 어떤 구역과 함께 하셨나요?`);
    }
  }

  if(errors.length){
    document.getElementById("result").innerText = "오류: " + errors.join("; ");
    return;
  }

  /* 종합 문자열 */
  const base = sums.map(v=>Math.round(v));
  let result = "종합/" + base.slice(0,6).join("/");

  const makeNameStr = obj =>
    Object.entries(obj).map(([n,v])=>`${n}${v}`).join(" ");

  if(base[6] > 0){
    result += `/${base[6]}(${makeNameStr(wordNames)})`;
  } else result += "/0";

  if(base[7] > 0){
    result += `/${base[7]}(${makeNameStr(centerNames)})`;
  } else result += "/0";

  document.getElementById("result").innerText = result;
};

document.getElementById("copyBtn").onclick = () => {
  navigator.clipboard.writeText(document.getElementById("result").innerText);
  alert("결과가 복사되었습니다!");
};
</script>

</body>
</html>
