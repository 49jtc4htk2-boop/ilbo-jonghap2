<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>일일 전도 활동 종합 계산기</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; padding:10px;}
h2 { text-align:center; margin-bottom:10px;}
textarea { width:100%; height:260px; font-size:16px; padding:10px; }
button { width:100%; font-size:16px; padding:10px; margin-top:6px; border:none; border-radius:5px; background:#4CAF50; color:#fff;}
#result { margin-top:10px; background:#fff; padding:10px; border-radius:5px; font-weight:bold; }
</style>
</head>
<body>

<h2>일일 전도 활동 종합 계산기</h2>

<textarea id="inputText" placeholder="일보 텍스트 붙여넣기"></textarea>
<button onclick="calculate()">종합하기</button>
<div id="result"></div>
<button onclick="copyResult()">결과 복사</button>

<script>
const COLS = ["섭외자보유","당일 찾기","당일 섭외","당일 만남","단계향상 만남","상담따기","말씀따기","센터확답"];
const CHECK_COLS = [1,2,3,4,5,6,7]; // 충돌 검사 대상 (섭외자보유 제외)

function calculate(){
  const text = document.getElementById("inputText").value;
  const lines = text.split(/\r?\n/);

  const sums = Array(8).fill(0);
  const appear = {};  // name -> [{row,col}]
  const half = {};
  const word = {};
  const center = {};

  lines.forEach((line, row)=>{
    if(!line.match(/^\d+\//)) return;
    const parts = line.split("/");

    parts.slice(2,10).forEach((cell, idx)=>{
      if(!cell) return;

      const num = cell.match(/^([\d.]+)/);
      if(num) sums[idx] += parseFloat(num[1]);

      const names = [...cell.matchAll(/([가-힣]+)(\.\d)?/g)];
      names.forEach(m=>{
        const name = m[1];
        const isHalf = m[2];

        if(isHalf){
          half[name] = (half[name]||0)+1;
        }

        if(idx===6){
          word[name] = (word[name]||0)+(isHalf?0.5:1);
        }
        if(idx===7){
          center[name] = (center[name]||0)+(isHalf?0.5:1);
        }

        appear[name] ??= [];
        appear[name].push({row, col:idx});
      });
    });
  });

  const errors = [];

  // 다른 줄 + 다른 칸 충돌
  for(const name in appear){
    const items = appear[name]
      .filter(o=>CHECK_COLS.includes(o.col));

    items.forEach(a=>{
      items.forEach(b=>{
        if(a.row!==b.row && a.col!==b.col){
          errors.push(
            `${name} (${a.row+1}구역 ${COLS[a.col]} ↔ ${b.row+1}구역 ${COLS[b.col]})`
          );
        }
      });
    });
  }

  // .5 단독
  for(const name in half){
    if(half[name]===1){
      errors.push(`"${name}.5"는 어떤 구역과 함께 하셨나요?`);
    }
  }

  if(errors.length){
    document.getElementById("result").innerText =
      "오류:\n" + [...new Set(errors)].join("\n");
    return;
  }

  // 정수화
  for(let i=0;i<sums.length;i++) sums[i] = Math.round(sums[i]);

  const wordText = Object.entries(word)
    .map(([n,v])=>`${n}${v}`).join(" ");
  const centerText = Object.entries(center)
    .map(([n,v])=>`${n}${v}`).join(" ");

  const result =
    "종합/" +
    sums.slice(0,6).join("/") + "/" +
    sums[6] + (wordText?`(${wordText})`:"") + "/" +
    sums[7] + (centerText?`(${centerText})`:"");

  document.getElementById("result").innerText = result;
}

function copyResult(){
  navigator.clipboard.writeText(
    document.getElementById("result").innerText
  );
  alert("복사 완료");
}
</script>

</body>
</html>
