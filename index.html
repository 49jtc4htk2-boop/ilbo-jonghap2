<script>
function getColName(index){
  return ["","",
    "섭외자보유","당일 찾기","당일 섭외","당일 만남",
    "단계향상 만남","상담따기","말씀따기","센터확답"
  ][index];
}

document.getElementById('calculateBtn').onclick = () => {
  const text = document.getElementById('inputText').value;
  const lines = text.split(/\r?\n/);

  const sum = [0,0,0,0,0,0,0,0];
  const wordMap = {};
  const centerMap = {};
  const namePos = {};
  const halfCount = {};
  const errors = [];

  lines.forEach((line, lineIdx) => {
    if (!line.match(/^\d+\//)) return;
    const cols = line.split('/');

    for (let i = 2; i <= 9; i++) {
      if (!cols[i]) continue;

      // 숫자 합산
      const num = parseFloat(cols[i]);
      if (!isNaN(num)) sum[i-2] += num;

      // 괄호 안 처리
      const matches = cols[i].match(/\(([^)]+)\)/g);
      if (!matches) continue;

      matches.forEach(m => {
        m.replace(/[()]/g,'').split(' ').forEach(n => {
          const match = n.match(/^(.+?)(\d+(\.\d+)?)$/);
          if (!match) return;

          const name = match[1];
          const val = parseFloat(match[2]);

          // 위치 기록 (다른 줄, 다른 칸 오류용)
          namePos[name] ??= {};
          namePos[name][i] ??= new Set();
          namePos[name][i].add(lineIdx);

          // .5 단독 체크
          if (val === 0.5) {
            halfCount[name] = (halfCount[name]||0)+1;
          }

          // 말씀따기 / 센터확답 누적
          if (i === 8) wordMap[name] = (wordMap[name]||0)+val;
          if (i === 9) centerMap[name] = (centerMap[name]||0)+val;
        });
      });
    }
  });

  // 다른 줄 다른 칸 오류
  Object.entries(namePos).forEach(([name, cols])=>{
    const keys = Object.keys(cols);
    if (keys.length > 1) {
      errors.push(`"${name}": ${getColName(keys[0])} vs ${getColName(keys[1])}`);
    }
  });

  // .5 단독 오류
  Object.entries(halfCount).forEach(([n,c])=>{
    if (c === 1) errors.push(`"${n}.5"는 어떤 구역과 함께 하셨나요?`);
  });

  if (errors.length) {
    document.getElementById('result').innerText = "오류: " + errors.join('; ');
    return;
  }

  // 이름 문자열 생성 함수
  const nameText = map =>
    Object.entries(map)
      .map(([n,v])=>`${n}${Number.isInteger(v)?v:v}`)
      .join(' ');

  const result =
    `종합/${sum.slice(0,6).map(n=>Math.round(n)).join('/')}/` +
    `${Math.round(sum[6])}${Object.keys(wordMap).length?`(${nameText(wordMap)})`:''}/` +
    `${Math.round(sum[7])}${Object.keys(centerMap).length?`(${nameText(centerMap)})`:''}`;

  document.getElementById('result').innerText = result;
};
</script>
