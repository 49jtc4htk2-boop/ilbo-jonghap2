<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì¼ì¼ í™œë™ ë³´ê³  ìë™ ì¢…í•©</title>
  <style>
    :root{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,'Noto Sans KR',Arial;}
    body{max-width:980px;margin:20px auto;padding:18px;background:#fbfbfb;border:1px solid #eee;border-radius:10px}
    h1{font-size:20px;margin:0 0 12px}
    textarea{width:100%;min-height:260px;padding:12px;font-size:13px;border-radius:8px;border:1px solid #ddd;resize:vertical}
    .row{display:flex;gap:8px;margin-top:8px}
    button{padding:10px 14px;border-radius:8px;border:0;background:#0b76ef;color:#fff;cursor:pointer}
    button.secondary{background:#6c757d}
    pre{white-space:pre-wrap;background:#fff;padding:12px;border-radius:8px;border:1px solid #ececec;min-height:80px}

    /* ìƒˆ ì˜¤ë¥˜ë°•ìŠ¤ */
    .error-box{
      background:#fff6e6;
      border-left:6px solid #ffa63e;
      padding:14px 16px;
      border-radius:6px;
      color:#6a3c00;
      margin-bottom:20px;
      line-height:1.55;
      font-size:14px;
    }
    .error-box strong{
      font-size:15px;
      display:block;
      margin-bottom:6px;
    }

    label{font-weight:600}
    .hint{font-size:12px;color:#666;margin-top:6px}
  </style>
</head>
<body>
  <h1>ğŸŒ³ ì¼ì¼ ì „ë„ í™œë™ ì¢…í•© ğŸŒ³</h1>

  <div class="error-box">
    <strong>ğŸ“Œ ì˜¤ë¥˜ ì•ˆë‚´</strong>
    - êµ¬ì—­ë³„ ë°ì´í„° ì¹¸ ìˆ˜ê°€ 10ê°œê°€ ì•„ë‹Œ ê²½ìš°<br>
    - ê´„í˜¸ ì•ˆ ì¸ì› í•©ê³„ì™€ ê´„í˜¸ ì• ìˆ«ìê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°<br>
    - ë‹¤ë¥¸ êµ¬ì—­ì—ì„œ ê°™ì€ ì´ë¦„ ë“±ì¥ ì‹œ, ë™ëª…ì´ì¸ ì—¬ë¶€ í™•ì¸ í›„ ì˜¤ë¥˜ ì²˜ë¦¬<br>
    - .5 ì¸ì›ì´ ë‹¨ë… ë“±ì¥í•˜ëŠ” ê²½ìš°<br>
  </div>

  <textarea id="input" placeholder="ì—¬ê¸°ì— ì¼ë³´ ì „ì²´ í…ìŠ¤íŠ¸ ë¶™ì—¬ë„£ê¸°"></textarea>

  <div class="row">
    <button id="calc">ê³„ì‚°í•˜ê¸°</button>
    <button class="secondary" id="clear">ì§€ìš°ê¸°</button>
    <button id="copy" title="ë³µì‚¬">ê²°ê³¼ ë³µì‚¬</button>
  </div>

  <h3 style="margin-top:16px">ê²°ê³¼</h3>
  <div id="result"></div>

  <script>
    const trim = s => s.replace(/^\s+|\s+$/g, '');
    const floatEq = (a,b,t=0.001) => Math.abs(a-b) < t;

    const COLS = ['êµ¬ì—­ë²ˆí˜¸','êµ¬ì—­ì¥','ì„­ì™¸ìë³´ìœ ','ì°¾ê¸°','ì„­ì™¸','ë§Œë‚¨','ë‹¨ê³„í–¥ìƒ','ìƒë‹´','ë§ì”€ë”°ê¸°','ì„¼í„°í™•ë‹µ'];

    /** ------------------------
        âœ” ìˆ˜ì •í¬ì¸íŠ¸ 1 â€” ìˆ«ìì¹¸ ì •ì˜
        êµ¬ì—­ë²ˆí˜¸, êµ¬ì—­ì¥ ì œì™¸ ëª¨ë“  ì¹¸ ìˆ«ìë§Œ í—ˆìš©
     ------------------------- */
    const numericOnlyCols = new Set([
      'ì„­ì™¸ìë³´ìœ ','ì°¾ê¸°','ì„­ì™¸','ë§Œë‚¨','ë‹¨ê³„í–¥ìƒ','ìƒë‹´','ë§ì”€ë”°ê¸°','ì„¼í„°í™•ë‹µ'
    ]);

    function parseBlock(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(l=>l!=="");
      if(lines.length===0) return {error:['ì…ë ¥ í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.']};

      const dataLines = lines.filter(l => /^\d+\//.test(l));
      if(dataLines.length===0) return {error:['êµ¬ì—­ ë°ì´í„° ë¼ì¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì˜ˆ: 1/í˜„ìŠ¹í™”/...)']};

      const rows = [];
      const errors = [];
      const nameMap = new Map();  // ì´ë¦„ â†’ ì¶œí˜„ì§€ ì €ì¥

      dataLines.forEach((line, idx) => {
        const parts = line.split('/');
        parts.forEach((v,i)=> parts[i] = trim(v));

        if(parts.length !== 10){
          const zone = parts[0] || `(ë¼ì¸ ${idx+1})`;
          errors.push(`${zone}êµ¬ì—­ ì¹¸ ê°œìˆ˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.`);
          rows.push({raw:line, parts});
          return;
        }

        const zone = parts[0];
        const obj = {zone, raw:line, parts:{}};

        for(let i=1;i<10;i++){
          const colName = COLS[i];
          const rawCell = parts[i];

          /** â¬‡ ìˆ˜ì •í¬ì¸íŠ¸ 2: ìˆ«ì ì¹¸ì€ ìµœìƒë‹¨ì—ì„œ ìˆ«ì í˜•ì‹ ê²€ì¦ */
          if(numericOnlyCols.has(colName)){
            if(!/^\d+(\.\d+)?(\(.*\))?$/.test(rawCell)){
              errors.push(`${zone}êµ¬ì—­ ${colName}ì—ëŠ” ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤: "${rawCell}"`);
            }
          }

          // ê¸°ì¡´ logic â€” count(name) parsing ìœ ì§€
          const m = rawCell.match(/^(\d+(?:\.\d+)?)(?:\((.*)\))?$/);
          if(!m){
            obj.parts[colName] = {raw:rawCell, count:null, names:[]};
            continue;
          }

          const count = parseFloat(m[1]);
          const inside = m[2] ? trim(m[2]) : null;
          const names = [];

          if(inside){
            const tokens = inside.split(/\s+/).filter(Boolean);
            tokens.forEach(tok=>{
              tok = tok.replace(/[,ï¼Œ\/]+$/,'');
              let value=1, name=tok;
              if(/\.5$/.test(tok)){ value=0.5; name=tok.replace(/\.5$/,''); }
              else if(/1$/.test(tok) && !/[^\u0000-\u007F]1$/.test(tok)){ value=1; name=tok.replace(/1$/,''); }
              names.push({name,value});
            });
          }

          const sumNames = names.reduce((s,n)=>s+(parseFloat(n.value)||0),0);
          if(inside && !floatEq(sumNames,count)){
            errors.push(`${zone}êµ¬ì—­ ${colName} ê´„í˜¸ í•©ê³„ ë¶ˆì¼ì¹˜`);
          }

          obj.parts[colName] = {raw:rawCell,count,names};

          // â¬‡ ì´ë¦„ ìœ„ì¹˜ ì €ì¥
          names.forEach(n=>{
            if(!nameMap.has(n.name)) nameMap.set(n.name,[]);
            nameMap.get(n.name).push({zone,col:colName,value:n.value});
          });
        }
        rows.push(obj);
      });

      /** ---------------------------------------------
          âœ” ìˆ˜ì •í¬ì¸íŠ¸ 3 â€” ë‹¤ë¥¸ êµ¬ì—­ì—ì„œ ì´ë¦„ ì¤‘ë³µ ì‹œ íŒì—… í™•ì¸
          ê°™ì€ êµ¬ì—­(ê°™ì€ ì¤„)ì€ ì˜¤ë¥˜ ì•„ë‹˜!
      ----------------------------------------------*/

      const asked = new Set(); // ê°™ì€ ì´ë¦„ ì¤‘ë³µ ì§ˆë¬¸ ë°©ì§€

      for(const [name, occs] of nameMap){

        // ë‹¤ë¥¸ êµ¬ì—­ ë¹„êµ
        const byZone = new Map();
        occs.forEach(o=>{
          if(!byZone.has(o.zone)) byZone.set(o.zone,[]);
          byZone.get(o.zone).push(o);
        });

        if(byZone.size <= 1) continue; // ê°™ì€ êµ¬ì—­ ë‚´ë¶€ ì¤‘ë³µ â†’ í—ˆìš©

        if(!asked.has(name)){
          const ok = confirm(`"${name}" ì´ë¦„ì´ ì—¬ëŸ¬ êµ¬ì—­ì—ì„œ ë“±ì¥í•©ë‹ˆë‹¤.\në™ëª…ì´ì¸ì…ë‹ˆê¹Œ?`);
          asked.add(name);

          if(!ok){
            errors.push(`"${name}" â€” ë‹¤ë¥¸ êµ¬ì—­ ì¤‘ë³µ (ë™ëª…ì´ì¸ ì•„ë‹˜)`);
          }
        }
      }

      /** 0.5 ë‹¨ë… ë“±ì¥ ì²´í¬ */
      for(const [name,occs] of nameMap){
        let countHalf = occs.filter(o=>parseFloat(o.value)===0.5).length;
        if(countHalf===1 && occs.length===1){
          const only = occs[0];
          errors.push(`${only.zone}êµ¬ì—­ "${name}.5"ëŠ” ë‹¨ë… ë“±ì¥ì…ë‹ˆë‹¤.`);
        }
      }

      return {errors, rows, nameMap};
    }

    /** ê¸°ì¡´ summaryëŠ” ê·¸ëŒ€ë¡œ */
    function computeSummary(parsed){
      const rows = parsed.rows;
      const numericCols = ['ì„­ì™¸ìë³´ìœ ','ì°¾ê¸°','ì„­ì™¸','ë§Œë‚¨','ë‹¨ê³„í–¥ìƒ','ìƒë‹´'];
      const sums = {};
      numericCols.forEach(c=>sums[c]=0);

      const talkMap=new Map(), centerMap=new Map();

      for(const r of rows){
        for(const c of numericCols){
          const val = r.parts[c]?.count ?? 0;
          sums[c] += parseFloat(val);
        }
        const talk=r.parts['ë§ì”€ë”°ê¸°'], cen=r.parts['ì„¼í„°í™•ë‹µ'];
        if(talk?.names) talk.names.forEach(n=>talkMap.set(n.name,(talkMap.get(n.name)||0)+n.value));
        if(cen?.names) cen.names.forEach(n=>centerMap.set(n.name,(centerMap.get(n.name)||0)+n.value));
      }

      const namesToString = map => 
        [...map.entries()]
          .filter(([k,v])=>v>0)
          .sort((a,b)=>b[1]-a[1])
          .map(([k,v])=>`${k}${v}`)
          .join(' ');

      return {
        sums,
        talkStr: namesToString(talkMap),
        centerStr: namesToString(centerMap)
      };
    }

    /** ë²„íŠ¼ ì´ë²¤íŠ¸ */
    document.getElementById('calc').addEventListener('click',()=>{
      const text=document.getElementById('input').value;
      const parsed=parseBlock(text);
      const result=document.getElementById('result');

      if(parsed.error){
        result.textContent=parsed.error.join('\n');
        return;
      }
      if(parsed.errors?.length){
        result.textContent=parsed.errors.join('\n');
        return;
      }

      const summary=computeSummary(parsed);
      const original=text.split(/\r?\n/).filter(l=>l.trim()!=="");

      const numericCols=['ì„­ì™¸ìë³´ìœ ','ì°¾ê¸°','ì„­ì™¸','ë§Œë‚¨','ë‹¨ê³„í–¥ìƒ','ìƒë‹´'];
      const sums=summary.sums;

      let talkTotal=0, centerTotal=0;
      parsed.rows.forEach(r=>{ talkTotal+=parseFloat(r.parts['ë§ì”€ë”°ê¸°']?.count||0); });
      parsed.rows.forEach(r=>{ centerTotal+=parseFloat(r.parts['ì„¼í„°í™•ë‹µ']?.count||0); });

      const finalLine=[
        'ì¢…í•©',
        sums['ì„­ì™¸ìë³´ìœ '],
        sums['ì°¾ê¸°'],
        sums['ì„­ì™¸'],
        sums['ë§Œë‚¨'],
        sums['ë‹¨ê³„í–¥ìƒ'],
        sums['ìƒë‹´'],
        talkTotal,
        centerTotal
      ].join('/');

      const nameLine =
        (summary.talkStr?`ë§ì”€ë”°ê¸°(${summary.talkStr}) `:'') +
        (summary.centerStr?`ì„¼í„°í™•ë‹µ(${summary.centerStr})`:'');

      const output=[...original, finalLine + (nameLine?'\n'+nameLine:'')].join('\n');
      result.textContent=output;
    });

    document.getElementById('copy').addEventListener('click',()=>{
      const txt=document.getElementById('result').textContent;
      navigator.clipboard.writeText(txt).then(()=>alert('âœ… ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
    });

    document.getElementById('clear').addEventListener('click',()=>{
      document.getElementById('input').value='';
      document.getElementById('result').textContent='(ì•„ì§ ê³„ì‚°í•˜ì§€ ì•ŠìŒ)';
    });
  </script>
</body>
</html>
