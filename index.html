<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì¼ì¼ ì „ë„ í™œë™ ì¢…í•©</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  textarea { width: 100%; height: 250px; margin-bottom: 10px; }
  pre { background: #f4f4f4; padding: 10px; white-space: pre-wrap; }
  button { margin-top: 10px; padding: 10px 20px; }
</style>
</head>
<body>
<h2>ì¼ì¼ ì „ë„ í™œë™ ì¢…í•© ê³„ì‚°ê¸°</h2>
<textarea id="inputData" placeholder="ë³´ê³ ì„œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
<button onclick="calculate()">ì¢…í•© ê³„ì‚°</button>
<pre id="output"></pre>
<button onclick="copyResult()">ê²°ê³¼ ë³µì‚¬</button>

<script>
function parseNumber(str) {
    if(!str) return 0;
    let sum = 0;
    str.replace(/(\d+\.?\d*)/g, (_, n) => sum += parseFloat(n));
    return sum;
}

function extractNamesWithNumbers(str) {
    let result = [];
    if(!str) return result;
    const regex = /([^\d().]+)(\d+\.?\d*)?/g;
    let match;
    while((match = regex.exec(str)) !== null){
        let name = match[1].trim();
        let num = match[2] ? parseFloat(match[2]) : 1;
        result.push({name, num});
    }
    return result;
}

function calculate() {
    const raw = document.getElementById('inputData').value.trim();
    const lines = raw.split('\n').filter(l => l.trim() && !l.startsWith('ğŸŒ³') && !l.startsWith('1)') && !l.startsWith('2)') && !l.startsWith('ğŸ¤©') && !l.startsWith('ì¢…í•©'));
    
    if(lines.length < 1) {
        document.getElementById('output').textContent = 'ì…ë ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        return;
    }
    
    let header = lines.shift().split('/');
    let data = lines.map(l => l.split('/'));
    
    let totals = Array(header.length-2).fill(0);
    let specialNames = { 'ë§ì”€ë”°ê¸°': [], 'ì„¼í„°í™•ë‹µ': [] };
    let nameMap = {};
    let errors = [];
    
    data.forEach(row => {
        if(row.length != header.length){
            errors.push(`${row[0]} êµ¬ì—­ ì¹¸ ê°œìˆ˜ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.`);
            return;
        }
        for(let i=2;i<row.length;i++){
            const colName = header[i];
            const cell = row[i];
            
            let sum = 0;
            const names = extractNamesWithNumbers(cell);
            names.forEach(obj=>{
                sum += obj.num;
                if(!nameMap[obj.name]) nameMap[obj.name] = {};
                if(!nameMap[obj.name][colName]) nameMap[obj.name][colName] = [];
                nameMap[obj.name][colName].push({êµ¬ì—­: row[0], num: obj.num});
            });
            
            if(colName==='ì„­ì™¸ìë³´ìœ '){
                const firstNum = cell.match(/\d+\.?\d*/);
                totals[i-2] += firstNum ? parseFloat(firstNum[0]) : 0;
            } else {
                totals[i-2] += sum;
            }
            
            if(colName==='ë§ì”€ë”°ê¸°' || colName==='ì„¼í„°í™•ë‹µ'){
                names.forEach(obj=>{
                    specialNames[colName].push(`${obj.name}${obj.num}`);
                });
            }
        }
    });
    
    // ì¤‘ë³µ ê²€ì¦
    for(let name in nameMap){
        for(let col in nameMap[name]){
            const entries = nameMap[name][col];
            if(entries.length > 1){
                const totalNum = entries.reduce((a,b)=>a+b.num,0);
                if(totalNum === 1) continue; // .5 ë‹¨ì¼ ë“±ì¥ í—ˆìš©
                
                let groups = {};
                entries.forEach(e=>{
                    if(!groups[e.êµ¬ì—­]) groups[e.êµ¬ì—­] = [];
                    groups[e.êµ¬ì—­].push(e);
                });
                let keys = Object.keys(groups);
                if(keys.length>1){
                    // .5 ì˜ˆì™¸ ì²˜ë¦¬: ë‹¤ë¥¸ êµ¬ì—­ ë™ì¼ ì¹¸, ëª¨ë“  ìˆ«ìê°€ .5ì´ë©´ ì˜¤ë¥˜ ì•„ë‹˜
                    let allHalf = entries.every(e=>e.num === 0.5);
                    if(allHalf) continue;

                    for(let i=0;i<keys.length;i++){
                        for(let j=i+1;j<keys.length;j++){
                            // ë‹¹ì¼ì°¾ê¸°/ë‹¹ì¼ì„­ì™¸ ì˜ˆì™¸
                            if((col==='ë‹¹ì¼ì°¾ê¸°' && nameMap[name]['ë‹¹ì¼ì„­ì™¸']?.some(e=>e.êµ¬ì—­===keys[i])) ||
                               (col==='ë‹¹ì¼ì„­ì™¸' && nameMap[name]['ë‹¹ì¼ì°¾ê¸°']?.some(e=>e.êµ¬ì—­===keys[i]))) continue;
                            errors.push(`${name}, ${keys[i]}(${col}) vs ${keys[j]}(${col})`);
                        }
                    }
                }
            }
        }
    }
    
    if(errors.length>0){
        document.getElementById('output').textContent = `ì˜¤ë¥˜: ${errors.join(' ')}`;
        return;
    }
    
    // ì˜¤ë¥˜ ì—†ìœ¼ë©´ ì¢…í•© ê²°ê³¼ ê³„ì‚°
    let result = `ì¢…í•©/${totals.map((v,i)=>{
        let colName = header[i+2];
        if(colName==='ë§ì”€ë”°ê¸°') return `${v}(${specialNames[colName].join(' ')})`;
        if(colName==='ì„¼í„°í™•ë‹µ') return `${v}(${specialNames[colName].join(' ')})`;
        return v;
    }).join('/')}`;
    
    document.getElementById('output').textContent = result;
}

function copyResult(){
    const output = document.getElementById('output');
    navigator.clipboard.writeText(output.textContent);
    alert('ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
}
</script>
</body>
</html>
