<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>일일 전도 보고 분석기</title>
</head>
<body>

<h2>일일 전도 활동 보고</h2>

<textarea id="input" rows="20" cols="80" placeholder="여기에 보고 텍스트 붙여넣기"></textarea>
<br><br>

<button onclick="run()">분석</button>

<pre id="output"></pre>

<script>
function analyzeReport(text) {
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);

  const COLS = {
    FIND: 3,
    CAST: 4,
    MEET: 5,
    STEP: 6,
    COUNSEL: 7,
    WORD: 8,
    CENTER: 9
  };

  const sum = Array(8).fill(0);
  const nameMap = {};
  const wordMap = {};
  const centerMap = {};

  for (let i = 1; i < lines.length; i++) {
    if (lines[i].startsWith('종합')) break;
    const cols = lines[i].split('/');

    cols.forEach((cell, idx) => {
      if (!cell || cell === '0') return;

      const num = parseFloat(cell);
      if (!isNaN(num) && idx >= 2 && idx <= 9) {
        sum[idx - 2] += num;
      }

      const matches = cell.match(/\(([^)]+)\)/g);
      if (!matches) return;

      matches.forEach(m => {
        m.replace(/[()]/g, '').split(' ').forEach(n => {
          const r = n.match(/^(.+?)(\d+(\.\d+)?)$/);
          if (!r) return;

          const name = r[1];
          const val = parseFloat(r[2]);

          if (!nameMap[name]) nameMap[name] = { cols: new Set(), half: 0 };
          nameMap[name].cols.add(idx);
          if (val === 0.5) nameMap[name].half++;

          if (idx === COLS.WORD) wordMap[name] = (wordMap[name] || 0) + val;
          if (idx === COLS.CENTER) centerMap[name] = (centerMap[name] || 0) + val;
        });
      });
    });
  }

  const errors = [];

  Object.entries(nameMap).forEach(([name, info]) => {
    if (info.half === 1) {
      errors.push(`"${name}.5" 는 한 번만 기록되었습니다. 어떤 구역과 함께 하셨나요?`);
    }
  });

  if (errors.length) {
    return '오류:\n' + errors.join('\n');
  }

  const buildNames = map =>
    Object.entries(map).map(([n, v]) => `${n}${v}`).join(' ');

  return (
    '종합/' +
    sum.slice(0, 6).map(n => Math.round(n)).join('/') +
    `/${Math.round(sum[6])}${Object.keys(wordMap).length ? `(${buildNames(wordMap)})` : ''}` +
    `/${Math.round(sum[7])}${Object.keys(centerMap).length ? `(${buildNames(centerMap)})` : ''}`
  );
}

function run() {
  const text = document.getElementById('input').value;
  document.getElementById('output').textContent = analyzeReport(text);
}
</script>

</body>
</html>
